filter {
    #
    # for ignore particularly useless lines
    #

    grep {
        match => ["@message", "^(\w)*$"]
        negate => true
    }

    grep {
        match => ["@message", "^#"]
        negate => true
    }

    #
    # the various log types that we're interested in
    #

    grok {
        type => "apache_combined"
        pattern => "%{COMBINEDAPACHELOG}"
        add_tag => "apache"
    }

    grok {
        type => "iis_default"
        pattern => "%{DATESTAMP:datetime} %{HOST:s_sitename} %{HOST:s_computername} %{IP:s_ip} %{WORD:cs_method} %{URIPATHPARAM:cs_uri_stem} (?:%{NOTSPACE:cs_uri_query}|-) %{POSINT:s_port} (?:%{USER:cs_username}|-) %{IP:c_ip} (?:HTTP/%{NUMBER:cs_version}|-) (?:%{NOTSPACE:cs_user_agent}|-) (?:%{NOTSPACE:cs_cookie}|-) (?:%{URI:cs_referer}|-) (?:%{IPORHOST:cs_host}|-) %{POSINT:sc_status} %{INT:sc_substatus} %{INT:win32_status} %{POSINT:sc_bytes} %{POSINT:cs_bytes} %{POSINT:time_taken}"
        add_tag => "iis"
    }

    grok {
        type => "iis_tradingapi"
        pattern => "%{DATESTAMP:datetime} %{HOST:s_sitename} %{HOST:s_computername} %{IP:s_ip} %{WORD:cs_method} %{URIPATHPARAM:cs_uri_stem} (?:%{NOTSPACE:cs_uri_query}|-) %{POSINT:s_port} (?:%{USER:cs_username}|-) %{IP:c_ip} (?:HTTP/%{NUMBER:cs_version}|-) (?:%{NOTSPACE:cs_user_agent}|-) (?:%{NOTSPACE:cs_cookie}|-) (?:%{URI:cs_referer}|-) (?:%{IPORHOST:cs_host}|-) %{POSINT:sc_status} %{INT:sc_substatus} %{INT:win32_status} %{POSINT:sc_bytes} %{POSINT:cs_bytes} %{POSINT:time_taken}"
        add_tag => ["iis","ci_tradingapi"]
    }

    grok {
        type => "nginx_combined"
        pattern => "%{IPORHOST:remote_addr} - (?:%{USER:remote_user}|-) \[%{HTTPDATE:time_local}\] \"(?:%{WORD:request_method} %{URIPATHPARAM:request_uri}(?: HTTP/%{NUMBER:request_httpversion})?|-)\" %{INT:status} (?:%{INT:body_bytes_sent}|-) \"(?:%{URI:http_referer}|-)\" %{QS:http_user_agent}"
        add_tag => "nginx"
    }

    #
    # Tag TradingAPI events to map uri to http://labs.cityindex.com/docs/ > Contents > CIAPI Reference > HTTP Services > Group > Service
    #

    grep {
        type => "iis_tradingapi"
        add_field => [ "ci_tradingapi_servicegroup", "Market" ]
        add_field => [ "ci_tradingapi_servicename", "GetMarketInformation" ]
        match => [ "cs_method", "GET" ]
        match => [ "cs_uri_stem", "^/TradingApi/market/\d+/information$" ]
        drop => false
    }

    grep {
        type => "iis_tradingapi"
        add_field => [ "ci_tradingapi_servicegroup", "Authentication" ]
        add_field => [ "ci_tradingapi_servicename", "LogOn" ]
        match => [ "cs_method", "POST" ]
        match => [ "cs_uri_stem", "^/TradingApi/session$" ]
        drop => false
    }

    grep {
        type => "iis_tradingapi"
        add_field => [ "ci_tradingapi_servicegroup", "TradesAndOrders" ]
        add_field => [ "ci_tradingapi_servicename", "Trade" ]
        match => [ "cs_method", "POST" ]
        match => [ "cs_uri_stem", "^/TradingApi/order/newtradeorder$" ]
        drop => false
    }

    #
    # specify the date field names for various types
    #

    date {
        type => "apache_combined"
        match => [ "timestamp", "dd/MMM/yyyy:HH:mm:ss Z" ]
    }

    date {
        type => "iis_default"
        match => [ "datetime", "yyyy-MM-dd HH:mm:ss" ]
    }

    date {
        type => "nginx_combined"
        match => [ "time_local", "dd/MMM/YYYY:HH:mm:ss Z" ]
    }

    date {
        type => "stackato_apptail"
        match => [ "HumanTime", "ISO8601" ]
    }

    date {
        type => "stackato_event"
        match => [ "UnixTime", "UNIX" ]
    }

    date {
        type => "stackato_systail"
        match => [ "UnixTime", "UNIX" ]
    }

    #
    # type-casting for more advanced searches
    #

    mutate {
        convert => [ "status", "integer" ]
        convert => [ "body_bytes_sent", "integer" ]
        tags => [ "nginx" ]
    }

    mutate {
        convert => [ "s_port", "integer" ]
        convert => [ "sc_status", "integer" ]
        convert => [ "sc_substatus", "integer" ]
        convert => [ "win32_status", "integer" ]
        convert => [ "sc_bytes", "integer" ]
        convert => [ "cs_bytes", "integer" ]
        convert => [ "time_taken", "integer" ]
        gsub => [ "cs_referer", "\\+", " " ]
        tags => [ "iis" ]
    }

    json {
        type => "stackato_event"
        source => "Info"
        target => "data"
    }
}
